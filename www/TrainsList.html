<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <!--    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>-->
    <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
    <!-- Google Maps API -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <!-- Google CDN for jQuery -->

    <script>
        var stcode1 = "";
        var stcode2 = "";
        var trainNo = [];

        var selelctedValue = null;

        function onSelectValueInDropdown() {

            //Value selected from dropdown
            selelctedValue = $('#select-train-dd :selected').val();
            return selelctedValue;
        }

        //Get current date-http://stackoverflow.com/questions/1531093/how-to-get-current-date-in-javascript

        function getTodayDate() {
            var today = new Date();
            var dd = today.getDate();
            var mm = today.getMonth() + 1; //January is 0!
            var yyyy = today.getFullYear();

            if (dd < 10) {
                dd = '0' + dd
            }

            if (mm < 10) {
                mm = '0' + mm
            }

            today = mm + '/' + dd + '/' + yyyy;
            return today;
        }

        // main page function
        function fetchSessionVariables() {

            if (typeof (Storage) != "undefined") {
                stcode1 = localStorage.getItem("station1");
                stcode2 = localStorage.getItem("station2");
                document.getElementById('station1').innerHTML = stcode1;
                document.getElementById('station2').innerHTML = stcode2;
            }
            var apiLink = 'http://api.erail.in/trains/?key=3d970b43-550b-4568-9227-492697f47093&stnfrom=';
            var linkModified = apiLink + stcode1 + "&stnto=" + stcode2;
            var trainDropDown = "<option value='1' disabled='disabled' selected='selected'>Select a Train...</option>";
            $.ajax({
                type: 'GET',
                url: linkModified,
                dataType: 'json',
                success: function (data) {

                    for (var i = 0; i < data.result.length; i++) {

                        trainNo[i] = data.result[i].trainno;

                        //Code for Drop Down list
                        trainDropDown += "<option value='" + data.result[i].trainno + "'>" + data.result[i].name + "-" + data.result[i].trainno + "</option>";
                    }

                    if (data.result.length < 1) {
                        trainsListToDisplay = "No trains running on this route";
                    }

                    document.getElementById('select-train-dd').innerHTML = trainDropDown;

                },
                error: function (x, e) {
                    alert('ERROR');
                }
            });

        }

        //Route function

        function getStops() {

            var trainno = onSelectValueInDropdown();

            var apilink = 'http://api.erail.in/route/?key=3d970b43-550b-4568-9227-492697f47093&trainno=';
            apilink += trainno;
            var displayTable = "<table border='1'>"
            displayTable += "<tr><th>Stop Name</th><th>Arrival Time</th><th>Departure Time</th></tr>";


            $.ajax({
                type: 'GET',
                url: apilink,
                dataType: 'json',
                success: function (data) {

                    document.getElementById('trainname').innerHTML = data.result.name;
                    document.getElementById('trainno').innerHTML = data.result.trainno;

                    for (var i = 0; i < data.result.route[0].stn.length; i++) {
                        displayTable += "<tr>";
                        displayTable += "<td>" + data.result.route[0].stn[i].name + "</td>";
                        displayTable += "<td>" + data.result.route[0].stn[i].arr + "</td>";
                        displayTable += "<td>" + data.result.route[0].stn[i].dep + "</td>";
                        displayTable += "</tr>";
                    }
                    displayTable += "</table>";
                    document.getElementById('displaystoplist').innerHTML = displayTable;
                },
                error: function (x, e) {
                    alert('ERROR');
                }
            });
        }

        //LiveStatus function

        function getLiveStatus() {

            var trainno = onSelectValueInDropdown();

            var apilink = 'http://api.erail.in/live/?key=3d970b43-550b-4568-9227-492697f47093&trainno=';
            apilink += trainno;
            apilink += "&stnfrom=" + stcode1;
            apilink += "&date=" + getTodayDate();
            console.log(apilink);
            $.ajax({
                type: 'GET',
                url: apilink,
                dataType: 'json',
                success: function (data) {
                    if (data.status == "OK") {
                        alert(data.result.name + "-" + data.result.trainno);
                        document.getElementById('trainnm').innerHTML = data.result.name;
                        document.getElementById('trainid').innerHTML = data.result.trainno;
                        document.getElementById('delayrun').innerHTML = data.result.delayrun;
                        document.getElementById('statusat').innerHTML = data.result.statusat;
                        document.getElementById('statusmsg').innerHTML = data.result.statusmsg;
                        document.getElementById('platform').innerHTML = data.result.platform;
                    } else {
                        document.getElementById('status').innerHTML = data.status;
                    }

                },
                error: function (x, e) {
                    alert('ERROR');
                }
            });
        }

        //Map functions start

        var map; // Google map object

        // Initialize and display a google map
        $(function mapFunctionStart() {
            // Create a Google coordinate object for where to initially center the map
            var latlng = new google.maps.LatLng(21.0000, 78.0000); // Washington, DC

            // Map options for how to display the Google map
            var mapOptions = {
                zoom: 6,
                center: latlng
            };

            // Show the Google map in the div with the attribute id 'map-canvas'.
            map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

            // Update the Google map for the user's inputted address
            $("#mapmarker").load(function (event) {
                var geocoder = new google.maps.Geocoder(); // instantiate a geocoder object

                // Get the user's inputted address

                var address = localStorage.getItem("startStation");
                alert(address);
                // Make asynchronous call to Google geocoding API
                geocoder.geocode({
                    'address': address
                }, function (results, status) {
                    var addr_type = results[0].types[0]; // type of address inputted that was geocoded
                    if (status == google.maps.GeocoderStatus.OK)
                        ShowLocation(results[0].geometry.location, address, addr_type);
                    else
                        alert("Geocode was not successful for the following reason: " + status);
                });
            });
        });

        // Show the location (address) on the map.
        function ShowLocation(latlng, address, addr_type) {
            // Center the map at the specified location
            map.setCenter(latlng);

            // Set the zoom level according to the address level of detail the user specified
            var zoom = 12;
            switch (addr_type) {
            case "administrative_area_level_1":
                zoom = 6;
                break; // user specified a state
            case "locality":
                zoom = 10;
                break; // user specified a city/town
            case "street_address":
                zoom = 15;
                break; // user specified a street address
            }
            map.setZoom(zoom);

            // Place a Google Marker at the same location as the map center 
            // When you hover over the marker, it will display the title
            var marker = new google.maps.Marker({
                position: latlng,
                map: map,
                title: address
            });

            // Create an InfoWindow for the marker
            var contentString = "<b>" + address + "</b>"; // HTML text to display in the InfoWindow
            var infowindow = new google.maps.InfoWindow({
                content: contentString
            });

            // Set event to display the InfoWindow anchored to the marker when the marker is clicked.
            google.maps.event.addListener(marker, 'click', function () {
                infowindow.open(map, marker);
            });
        }

        //Map functions end
    </script>

    <style>
        /* style settings for Google map */
        
        #map-canvas {
            width: 400px;
            /* map width */
            
            height: 400px;
            /* map height */
        }
    </style>
</head>

<body onload="fetchSessionVariables();">

    <div data-role="page" id="pageone">
        <h1>Home page</h1>
        <div data-role="header">
            <h1>Indian Railways</h1>
            <h2>        
              <label id='station1'></label>>><label id='station2'></label></h2>
        </div>

        <div data-role="main" class="ui-content">
            <p>Welcome!</p>

            <form>
                <div class="ui-field-contain">
                    <label for="sselect-train-dd">Select a train</label>
                    <select name="select-train-dd" id="select-train-dd" onchange="onSelectValueInDropdown();" data-mini="false">
                    </select>
                </div>
            </form>
            <a href="#route" onclick="getStops();">Route Info</a>
            <a href="#liveStatus" onclick="getLiveStatus();" class="ui-btn ui-corner-all">Live Status</a>
            <a href="#mapmarker" onclick="mapFunctionStart();" class="ui-btn ui-corner-all">Map</a>
            <a href='SelectStations.html' alt='goback' class="ui-btn ui-corner-all">Go Back</a>
        </div>
        <div data-role="footer" data-position="fixed">
            <h1>&copy;Kushal Tare, Sudhanshu Mehrotra, Harshit Gindra</h1>
        </div>
    </div>

    <!--Route page-->

    <div data-role="page" id="route">
        <div data-role="header">
            <h1>Route Info</h1>
        </div>

        <div data-role="main" class="ui-content" id="routepage">
            <h3>Train Name: <label id='trainname'></label></h3>
            <h3>Train No: <label id='trainno'></label></h3>
            <div id='displaystoplist'></div>
        </div>
    </div>

    <!--Live Status page-->

    <div data-role="page" id="liveStatus">
        <div data-role="header">
            <h1>Live status</h1>
        </div>

        <div data-role="main" class="ui-content" id="routepage">
            <label id='status'></label>
            <h3>Train Name: <label id='trainnm'></label></h3>
            <h3>Train No: <label id='trainid'></label></h3>
            <h3>Dealyed By: <label id='delayrun'></label></h3>
            <h3>Status @: <label id='statusat'></label></h3>
            <h3>Status msg: <label id='statusmsg'></label></h3>
            <h3>Platform: <label id='platform'></label></h3>

        </div>
    </div>

    <!--Map Page-->

    <div data-role="page" id="mapmarker">
        <div data-role="header">
            <h1>Map Location</h1>
        </div>

        <div data-role="main" class="ui-content" id="routepage">
            <div id='map-canvas'></div>
            <br/>
            <div>
                <label for="address"> Address:</label>
                <input type="text" id="address" />
                <button id="locate">Locate</button>
            </div>

        </div>
    </div>
</body>

</html>